{% extends "index.html" %}

{% load static %}

<html>
    {% block content %}
    <body>

        <h1 style="font-family: quicksand;">Map from Google</h1>
        <div id="googleMap" style="width:100%;height:400px;"></div>
        
        <head>
            <link rel="stylesheet" type="text/css" href="/static/css/red_bttns.css" />   
            <link rel="stylesheet" type="text/css" href="/static/css/find_route_bttn.css" />   
            <script type="text/javascript" src="/static/js/cookies.js"></script>
            <script type="text/javascript" src="/static/js/place_types_arrays.js"></script>
        </head>
        

        <script>
            document.addEventListener("DOMContentLoaded", load);

            var search_query = "san francisco hike"                   //do this

            var travel_mode
            var driving = getCookie("driving");
            var walking = getCookie("walking");
            var transit = getCookie("transit");
            var bicycling = getCookie("bicycling");

            var type 
            var outdoor_activity = getCookie("outdoor_activity");
            var indoor_activity = getCookie("indoor_activity");
            var restaurant = getCookie("restaurant");
            var cafe = getCookie("cafe");
            var shopping = getCookie("shopping");
            var museum = getCookie("museum");
            // console.log(museum);

            var destination 

            var map
            var user_latitude 
            var user_longitude 
            var end_location
            var end_coords
           

            function load() {
                getLocation()
            }

            function getLocation() {                                       
                if (navigator.geolocation) { // Supported
                    navigator.geolocation.getCurrentPosition(getPosition) 
                } else { // Not supported
                    alert("Oops! This browser does not support HTML Geolocation.");
                }
            }

            function getPosition(position) {                                        //gets position of user from browser //
                user_latitude = position.coords.latitude;
                user_longitude = position.coords.longitude;

                const pos = {
                    lat: user_latitude,
                    lng: user_longitude,
                }

                map.setCenter(pos);
                console.log(pos)

                user_pos_marker();
                geocide();

            }


            function user_pos_marker() {

                var marker1 = new google.maps.Marker({                                     
                    position: {
                        lat: user_latitude,
                        lng: user_longitude,
                    }
                },
                );
                marker1.setMap(map); 

            }

            function end_pos_marker() {

                var marker2 = new google.maps.Marker({                                      
                    position: end_coords,
                    
                });

                marker2.setMap(map);                                                   
                console.log("set destination marker")

            }

            function myMap() {
                
                var mapProp = {                                                          
                    center: new google.maps.LatLng(user_latitude, user_longitude),
                    zoom: 13,
                };

                map = new google.maps.Map(document.getElementById("googleMap"), mapProp);  
                
            }

            function geocide() {
                console.log("geocide called")
                var geocoder = new google.maps.Geocoder()

                findplace();

                geocoder.geocode(
                    {
                        location: destination,
                    },
                    function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                           
                            end_location = results[0].geometry.location;

                            const lat = end_location.lat();
                            const lng = end_location.lng();

                            console.log(lat);
                            console.log(lng);

                            end_coords = {                                      //PROBLEM
                                lat: lat,
                                lng: lng,
                            };
                        }
                        else {
                            console.log("geocide failed")
                        }
                    },
                );      

                //console.log(end_coords)
                console.log("??")
            }


            function getCookie(cname) {
                var name = cname + "=";
                var decodedCookie = decodeURIComponent(document.cookie);

                var ca = decodedCookie.split(';');

                for(var i = 0; i <ca.length; i++) {
                    var c = ca[i];

                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }

                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }

                    //console.log(c.substring());
                }

                return "";
            }

            function findplace() {
                console.log("findplace called")

                var place = new google.maps.places.PlacesService();

                if (type==undefined) {
                    set_type();
                }  

                var request = {
                    query: search_query,
                    fields: ['name', 'formatted_address', type],
                    locationBias: {
                        radius: 1000, 
                        center: {
                            lat: user_latitude,
                            lng: user_longitude,
                        },
                    },
                
                };


                place.findPlaceFromQuery(request, function(results, status) {

                    console.log("OK: ", google.maps.places.PlacesServiceStatus.OK);

                    if (status == google.maps.places.PlacesServiceStatus.OK) {
                        
                        createMarker(results[0]);
                        
                        const placelocation = results[0].geometry.location;

                        var lat = placelocation.lat();
                        var lng = placelocation.lng();

                        destination = {
                            lat: lat,
                            lng: lng,
                        };                                                   //        <--------   
                        
                        console.log(destination) 
                    }
                    else {
                        console.log("findplace failed")
                    }

                });
            }   

            function createMarker(place) {
                var marker3 = new google.maps.Marker({
                map: map,
                position: place.geometry.location
                });

                marker3.setMap(map);
                console.log("set marker 3")
               
            }


            function set_type() {
                console.log("set_type called")
                if (outdoor_activity=='true') {
                    //psuedorandom pick a type from a list 
                    type = pass;
                }
                else if (indoor_activity=='true') {
                    type = pass;
                }
                else if (restaurant=='true') {
                    type = pass;
                }
                else if (cafe=='true') {
                    type = pass;
                }
                else if (shopping=='true') {
                    type = pass;
                }
                else if (museum=='true') {
                    type = 'museum';
                }
                else {
                    console.log("set_type failed")
                }

                console.log("type is " + type)
                
            }


            function settravelmode() {
                if (driving=='true') {
                    travel_mode="DRIVING";
                } 
                else if (transit=='true') {
                    travel_mode="TRANSIT";
                } 
                else if (walking=='true') {
                    travel_mode="WALKING";
                } 
                else if (bicycling=='true') {
                    travel_mode="BICYCLING";
                } 
                else {
                    travel_mode="DRIVING";
                }

                console.log("travelmode set")
            }


            function calcRoute() {         
                var directionsService = new google.maps.DirectionsService();
                var directionsDisplay = new google.maps.DirectionsRenderer();        

                geocide();

                var start = {
                    lat: user_latitude,
                    lng: user_longitude,
                }
                var end = end_coords;

                settravelmode();

                var request = {                                                        
                    origin: start,
                    destination: end_coords,
                    travelMode: travel_mode, 
                    unitSystem: google.maps.UnitSystem.IMPERIAL,

                };
                
                end_pos_marker();

                directionsService.route(request, function(result, status) {
                    if (status == 'OK') {
                        console.log("directions called");
                        directionsDisplay.setMap(map);
                        directionsDisplay.setDirections(result);                           
                    }
                    else {
                        console.log("directions failed");
                    }
                });
                
            }


        </script>

        <!-- gets map info from google -->
        <script 
        src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBatSFsLO7FcTGtpxjP7FcAwKaevJb1N_k&callback=myMap&libraries=places" 
        type="text/javascript"
        >
        </script>

        <!-- calculates route when button is pressed -->  
        <div class="btn find_r_container"> 
            <button type="button" onclick="calcRoute()" class="btn find_r_button">Find your route</button>
        </div>

    </body>

    {% endblock content %}
</html>